<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Demo: Selector.stats()</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: sans-serif; background: #f0f2f5; padding: 24px; }
    h1 { font-size: 22px; margin-bottom: 4px; color: #1a1a2e; }
    .subtitle { font-size: 14px; color: #555; margin-bottom: 24px; }
    h2 { font-size: 14px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: .6px; margin-bottom: 10px; margin-top: 24px; }

    /* ── Comparison badge ── */
    .diff-badge {
      display: inline-block; padding: 3px 10px; border-radius: 99px;
      background: #fef3c7; border: 1.5px solid #fcd34d; font-size: 12px;
      font-weight: 700; color: #92400e; margin-bottom: 16px;
    }

    /* ── Stats dashboard ── */
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px; margin-bottom: 20px;
    }
    .stat-card {
      background: #fff; border-radius: 12px; padding: 18px 16px;
      border: 2px solid #dde1e7; text-align: center; transition: border-color .3s;
    }
    .stat-card .label { font-size: 11px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; }
    .stat-card .value { font-size: 28px; font-weight: 700; color: #0891b2; font-family: monospace; transition: color .3s; }
    .stat-card .sub { font-size: 11px; color: #aaa; margin-top: 4px; font-family: monospace; }
    .stat-card.highlight { border-color: #38bdf8; background: #f0f9ff; }
    .stat-card.highlight .value { color: #0891b2; }
    .stat-card.extra { border-color: #fcd34d; background: #fffbeb; }
    .stat-card.extra .value { color: #d97706; }

    /* ── Breakdown box ── */
    .breakdown-box {
      background: #fff; border-radius: 12px; padding: 16px 18px;
      border: 2px solid #dde1e7; margin-bottom: 16px;
    }
    .breakdown-box h3 { font-size: 12px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 10px; }
    .breakdown-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f3f4f6; font-size: 13px; }
    .breakdown-row:last-child { border: none; }
    .breakdown-key { font-family: monospace; color: #0891b2; font-weight: 600; }
    .breakdown-val { font-family: monospace; color: #333; font-weight: 700; }
    .breakdown-empty { font-size: 13px; color: #aaa; font-style: italic; }

    /* ── Controls ── */
    .controls {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      background: #fff; padding: 12px 16px; border-radius: 10px;
      border: 1px solid #e2e8f0; margin-bottom: 14px;
    }
    .btn { padding: 7px 16px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; color: #fff; }
    .btn-hit     { background: #0891b2; } .btn-hit:hover     { background: #0e7490; }
    .btn-miss    { background: #dc2626; } .btn-miss:hover    { background: #b91c1c; }
    .btn-refresh { background: #4f46e5; } .btn-refresh:hover { background: #4338ca; }

    /* ── Demo elements ── */
    .demo-elements { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .demo-el {
      padding: 8px 14px; border-radius: 8px; background: #fff;
      border: 2px solid #dde1e7; font-size: 13px; font-weight: 600; color: #555;
      transition: all .25s;
    }
    .demo-el.queried { border-color: #38bdf8; background: #e0f2fe; color: #0c4a6e; }

    /* ── Log panel ── */
    .log-panel {
      background: #1e1e2e; border-radius: 10px; padding: 14px 16px;
      font-family: monospace; font-size: 12px; color: #cdd6f4;
      max-height: 160px; overflow-y: auto; margin-bottom: 20px;
    }
    .log-panel .log-line { padding: 2px 0; border-bottom: 1px solid #313244; }
    .log-panel .log-line:last-child { border: none; }
    .log-hit  { color: #a6e3a1; }
    .log-miss { color: #f38ba8; }
    .log-info { color: #89dceb; }

    .results { display: flex; flex-direction: column; gap: 8px; }
    .result-row { display: flex; align-items: center; gap: 10px; background: #fff; border-radius: 8px; padding: 10px 14px; border-left: 4px solid #ccc; font-size: 14px; color: #333; }
    .result-row.pass { border-left-color: #16a34a; }
    .result-row.fail { border-left-color: #dc2626; background: #fff5f5; }
    .badge { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 99px; flex-shrink: 0; }
    .pass .badge { background: #dcfce7; color: #15803d; }
    .fail .badge { background: #fee2e2; color: #b91c1c; }
  </style>
</head>
<body>
  <h1>Demo — <code>Selector.stats()</code></h1>
  <p class="subtitle">Returns a snapshot of the Selector helper's internal statistics: hits, misses, cache size, hit rate, uptime, and a <strong>selectorBreakdown</strong> map of query types used. Identical to <code>Collections.stats()</code> but includes the extra <code>selectorBreakdown</code> field.</p>

  <div class="diff-badge">+ selectorBreakdown vs Collections.stats()</div>

  <!-- ── Live stat cards ── -->
  <h2>Live statistics dashboard</h2>
  <div class="stats-grid" id="stats-grid">
    <div class="stat-card" id="sc-hits">
      <div class="label">hits</div>
      <div class="value" id="sv-hits">—</div>
      <div class="sub">cache hits</div>
    </div>
    <div class="stat-card" id="sc-misses">
      <div class="label">misses</div>
      <div class="value" id="sv-misses">—</div>
      <div class="sub">cache misses</div>
    </div>
    <div class="stat-card" id="sc-hitrate">
      <div class="label">hit rate</div>
      <div class="value" id="sv-hitrate">—</div>
      <div class="sub">% of cache hits</div>
    </div>
    <div class="stat-card" id="sc-cachesize">
      <div class="label">cache size</div>
      <div class="value" id="sv-cachesize">—</div>
      <div class="sub">entries in cache</div>
    </div>
    <div class="stat-card" id="sc-uptime">
      <div class="label">uptime</div>
      <div class="value" id="sv-uptime">—</div>
      <div class="sub">ms since cleanup</div>
    </div>
    <div class="stat-card extra" id="sc-breakdown">
      <div class="label">selector types</div>
      <div class="value" id="sv-breakdown">—</div>
      <div class="sub">unique types queried</div>
    </div>
  </div>

  <!-- ── Selector breakdown ── -->
  <h2>selectorBreakdown (Selector-only field)</h2>
  <div class="breakdown-box">
    <h3>Query type counts</h3>
    <div id="breakdown-rows">
      <div class="breakdown-empty">Make some queries to see selector type counts</div>
    </div>
  </div>

  <!-- ── Demo elements ── -->
  <h2>Query targets</h2>
  <div class="demo-elements">
    <div class="demo-el scard" id="s1">Card A</div>
    <div class="demo-el scard" id="s2">Card B</div>
    <div class="demo-el scard" id="s3">Card C</div>
    <div class="demo-el xcard" id="s4">Other</div>
    <div class="demo-el xcard" id="s5">Other</div>
  </div>

  <div class="controls">
    <button class="btn btn-hit"     onclick="doHit()">Cache HIT — query '.scard' again</button>
    <button class="btn btn-miss"    onclick="doMiss()">Cache MISS — query '.zzz' (new)</button>
    <button class="btn btn-refresh" onclick="refreshStats()">Refresh stats display</button>
  </div>

  <!-- ── Log panel ── -->
  <h2>Query log</h2>
  <div class="log-panel" id="log-panel">
    <div class="log-line log-info">— Waiting for first query —</div>
  </div>

  <h2>Automated test results</h2>
  <div class="results" id="results"></div>

  <script src="https://cdn.jsdelivr.net/npm/dom-helpers-js@2.4.3/dist/dom-helpers.min.js"></script>
  <script>
    const resultsEl = document.getElementById('results');

    function addResult(pass, label, detail) {
      const row = document.createElement('div');
      row.className = 'result-row ' + (pass ? 'pass' : 'fail');
      row.innerHTML = '<span class="badge">' + (pass ? 'PASS' : 'FAIL') + '</span><strong>' + label + '</strong>' + (detail ? ' — <span style="color:#666">' + detail + '</span>' : '');
      resultsEl.appendChild(row);
    }

    let queryCount = 0;

    function refreshStats() {
      const s = Selector.stats();

      document.getElementById('sv-hits').textContent      = s.hits;
      document.getElementById('sv-misses').textContent    = s.misses;
      document.getElementById('sv-hitrate').textContent   = (s.hitRate * 100).toFixed(1) + '%';
      document.getElementById('sv-cachesize').textContent = s.cacheSize;
      document.getElementById('sv-uptime').textContent    = s.uptime;

      const breakdown = s.selectorBreakdown || {};
      const keys = Object.keys(breakdown);
      document.getElementById('sv-breakdown').textContent = keys.length;

      const rowsEl = document.getElementById('breakdown-rows');
      rowsEl.innerHTML = '';
      if (keys.length === 0) {
        rowsEl.innerHTML = '<div class="breakdown-empty">No queries yet</div>';
      } else {
        keys.forEach(k => {
          const row = document.createElement('div');
          row.className = 'breakdown-row';
          row.innerHTML = '<span class="breakdown-key">' + k + '</span><span class="breakdown-val">' + breakdown[k] + '</span>';
          rowsEl.appendChild(row);
        });
      }

      // Highlight changed cards
      ['sc-hits','sc-misses','sc-hitrate','sc-cachesize','sc-uptime','sc-breakdown'].forEach(id => {
        const card = document.getElementById(id);
        card.classList.add('highlight');
        setTimeout(() => card.classList.remove('highlight'), 600);
      });
    }

    function logLine(text, cls) {
      const panel = document.getElementById('log-panel');
      const placeholder = panel.querySelector('.log-info');
      if (placeholder && placeholder.textContent.includes('Waiting')) placeholder.remove();
      const line = document.createElement('div');
      line.className = 'log-line ' + cls;
      line.textContent = '[' + queryCount + '] ' + text;
      panel.appendChild(line);
      panel.scrollTop = panel.scrollHeight;
    }

    function doHit() {
      queryCount++;
      const col = Selector.queryAll('.scard');
      const s   = Selector.stats();
      document.querySelectorAll('.scard').forEach(el => {
        el.classList.add('queried');
        setTimeout(() => el.classList.remove('queried'), 500);
      });
      logLine("Selector.queryAll('.scard') → " + col.length + ' elements  [hits: ' + s.hits + ', misses: ' + s.misses + ']', 'log-hit');
      refreshStats();
    }

    function doMiss() {
      queryCount++;
      Selector.queryAll('.zzz' + queryCount);
      const s = Selector.stats();
      logLine("Selector.queryAll('.zzz" + queryCount + "') → 0 elements  [hits: " + s.hits + ', misses: ' + s.misses + ']', 'log-miss');
      refreshStats();
    }

    // ── Initial populate ─────────────────────────────────────────────────────
    Selector.queryAll('.scard'); // warm up
    refreshStats();

    // ── Automated tests ──────────────────────────────────────────────────────
    const s0 = Selector.stats();

    addResult(typeof s0 === 'object' && s0 !== null, 'stats() returns an object', 'keys: ' + Object.keys(s0).join(', '));

    addResult(typeof s0.hits === 'number',      'stats().hits is a number',      'value: ' + s0.hits);
    addResult(typeof s0.misses === 'number',    'stats().misses is a number',    'value: ' + s0.misses);
    addResult(typeof s0.cacheSize === 'number', 'stats().cacheSize is a number', 'value: ' + s0.cacheSize);
    addResult(typeof s0.hitRate === 'number',   'stats().hitRate is a number',   'value: ' + s0.hitRate.toFixed(3));
    addResult(typeof s0.uptime === 'number',    'stats().uptime is a number',    'value: ' + s0.uptime + 'ms');

    // selectorBreakdown — Selector-only field
    addResult(
      typeof s0.selectorBreakdown === 'object' && s0.selectorBreakdown !== null,
      'stats().selectorBreakdown is an object (Selector-only field)',
      'type: ' + typeof s0.selectorBreakdown
    );

    // hitRate range
    addResult(s0.hitRate >= 0 && s0.hitRate <= 1, 'hitRate is between 0 and 1', s0.hitRate.toFixed(3));

    // cacheSize grows after new query
    const sizeBefore = Selector.stats().cacheSize;
    Selector.queryAll('.unique-stat-class-abc123');
    const sizeAfter = Selector.stats().cacheSize;
    addResult(sizeAfter >= sizeBefore, 'cacheSize grows after new query', sizeBefore + ' → ' + sizeAfter);

    // misses grow on unknown selector
    const missesBefore = Selector.stats().misses;
    Selector.queryAll('.definitely-does-not-exist-xyz99');
    const missesAfter = Selector.stats().misses;
    addResult(missesAfter > missesBefore, 'misses increment on cache miss (empty result)', missesBefore + ' → ' + missesAfter);

    // hits grow on repeated query
    Selector.queryAll('.scard');
    const hitsBefore = Selector.stats().hits;
    Selector.queryAll('.scard');
    const hitsAfter = Selector.stats().hits;
    addResult(hitsAfter > hitsBefore, 'hits increment on cache hit (repeated query)', hitsBefore + ' → ' + hitsAfter);

    // uptime is non-negative
    addResult(s0.uptime >= 0, 'uptime is non-negative', s0.uptime + 'ms');

    // selectorBreakdown tracks query types
    const s1 = Selector.stats();
    const breakdown = s1.selectorBreakdown || {};
    addResult(Object.keys(breakdown).length > 0, 'selectorBreakdown has entries after queries', 'types: ' + Object.keys(breakdown).join(', '));

    refreshStats();
  </script>
</body>
</html>
